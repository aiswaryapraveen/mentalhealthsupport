{% extends 'core/base2.html' %}

{% block content %}
<div class="container">
    <h2 class="mt-4">Welcome, {{ user.username }}!</h2>
    {% if not request.user.is_superuser and not request.user.is_professional %}
    <div class="container mt-5">
        <h2 class="fw-bold text-center text-dark">üìñ Daily Journal</h2>
        <p class="text-muted text-center">Express yourself and track your mental well-being over time.</p>

        <!-- Journal Entry Form -->
        <div class="card p-4 shadow-sm border-0 rounded-4 mt-4 bg-light">
            <div class="card-body">
                <h4 class="fw-bold text-dark">Write Your Thoughts</h4>
                <form method="POST" action="{% url 'analyze_journal' %}">
                    {% csrf_token %}
                    <textarea class="form-control shadow-sm rounded-4 p-3" name="journal_entry" rows="5" placeholder="How are you feeling today?" style="resize: none; background: #f8f9fa;"></textarea>
                    <button type="submit" class="btn btn-dark mt-3 w-100 fw-bold rounded-pill">Analyze & Save</button>
                </form>
            </div>
        </div>


        <!-- Journal Entries -->
        <h4 class="fw-bold mt-5">üìú Your Past Entries</h4>
        {% if entries %}
        <div class="journal-entries mt-3">
            {% for date, date_entries in entries.items %}
            <div class="date-group mb-3">
                <button class="btn btn-outline-dark w-100 text-start fw-bold" data-bs-toggle="collapse" data-bs-target="#collapse-{{ date|date:'Ymd' }}">
                    üìÖ {{ date }} <span class="float-end">‚ñº</span>
                </button>
                
                <div id="collapse-{{ date|date:'Ymd' }}" class="collapse mt-2">
                    {% for entry in date_entries %}
                    <div class="card shadow-sm border-0 rounded-4 mb-2">
                        <div class="card-body">
                            <p class="text-dark">{{ entry.text }}</p>
                            {% if entry.mental_health_status == "Normal" %}
                                <p class="fw-bold text-primary mt-2">üß† {{ entry.sentiment }}</p>
                            {% else %}
                                <p class="fw-bold text-primary mt-2">üß† {{ entry.mental_health_status }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted fst-italic text-center mt-3">No journal entries yet. Start writing your thoughts!</p>
        {% endif %}

        <!-- JavaScript for Expanding Entries -->
        <script>
            function showMoreEntries(btn) {
                let parent = btn.closest('.date-group');
                let hiddenEntries = parent.querySelectorAll('.journal-entry:nth-child(n+6)');
                hiddenEntries.forEach(entry => entry.style.display = 'block');
                btn.style.display = 'none'; // Hide 'View More' button after clicking
            }
        </script>
        <style>
            .journal-entries .card {
                transition: transform 0.3s ease-in-out, box-shadow 0.3s;
                background: #f8f9fa;
                cursor: pointer;
            }
            .journal-entries .card:hover {
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }
            textarea:focus {
                border-color: #007bff !important;
                box-shadow: 0 0 10px rgba(0, 123, 255, 0.3) !important;
            }
            /* Custom styling for journal entry collapsible sections */
            .date-group {
                border-radius: 10px;
                overflow: hidden;
            }

            .date-group button {
                background-color: #f8f9fa;
                color: #333;
                padding: 12px;
                border-radius: 8px;
                border: none;
                font-size: 16px;
                transition: all 0.3s ease-in-out;
            }

            .date-group button:hover {
                background-color: #007bff;
                color: white;
            }

            .date-group button span {
                transition: transform 0.3s ease-in-out;
            }

            .date-group button[aria-expanded="true"] span {
                transform: rotate(180deg); /* Flip arrow when expanded */
            }

            .card {
                background: white;
                border-left: 4px solid #007bff;
                padding: 15px;
                transition: all 0.3s ease-in-out;
            }

            .card:hover {
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }

            .card p {
                margin: 0;
                color: #333;
            }

            .text-primary {
                font-weight: bold;
            }
        </style>
    {% endif %}


    <!-- Admin Dashboard -->
    {% if user.is_superuser %}
    <div class="admin-dashboard mt-5">
        <h3 class="text-center text-danger fw-bold">‚ö° Admin Dashboard</h3>

        <!-- Admin Statistics -->
        <div class="row text-center mt-4">
            <div class="col-md-4">
                <div class="card shadow-lg border-0 admin-stat-card bg-light">
                    <div class="card-body">
                        <h5 class="card-title fw-bold text-primary">üë• Total Users</h5>
                        <p class="fw-bold display-6 count" data-count="{{ total_users }}">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-lg border-0 admin-stat-card bg-light">
                    <div class="card-body">
                        <h5 class="card-title fw-bold text-success">üéì Professionals</h5>
                        <p class="fw-bold display-6 count" data-count="{{ total_professionals }}">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-lg border-0 admin-stat-card bg-light">
                    <div class="card-body">
                        <h5 class="card-title fw-bold text-warning">‚è≥ Pending Approvals</h5>
                        <p class="fw-bold display-6 count" data-count="{{ pending_approvals }}">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Styling -->
    <style>
        .admin-stat-card {
            transition: transform 0.3s ease-in-out;
            border-radius: 12px;
        }
        .admin-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
    </style>

    <!-- Animated Counter -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".count").forEach(counter => {
                let countTo = parseInt(counter.getAttribute("data-count"));
                let count = 0;
                let speed = Math.ceil(countTo / 50); 

                let updateCount = setInterval(() => {
                    count += speed;
                    if (count >= countTo) {
                        counter.textContent = countTo;
                        clearInterval(updateCount);
                    } else {
                        counter.textContent = count;
                    }
                }, 30);
            });
        });
    </script>
    {% endif %}

    <!-- Professional Dashboard -->
    {% if user.is_professional %}
    <div class="alert alert-info mt-4 text-center fw-bold">
        üéì Mentor-Session Dashboard
    </div>
    {% endif %}
</div>

<!-- Additional Styling -->
<style>
    .accordion-button:focus {
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5) !important;
    }
    .accordion-button {
        transition: background 0.3s ease-in-out;
    }
    .accordion-button:hover {
        background: #f8f9fa !important;
    }
    .btn-primary {
        background: #007bff;
        border: none;
    }
    .btn-primary:hover {
        background: #0056b3;
    }
</style>

{% endblock %}
